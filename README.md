# Huawei Solar Battery Optimization

# Huawei Solar Battery Optimization

This Home Assistant package provides a set of scripts and automations to optimize the use of a Huawei solar battery system. It aims to maximize self-consumption, optimize charging/discharging of the Huawei Battery based on electricity prices, and manage grid export based on electricity spot prices.

## Features

- Daily optimization of battery usage
- Seasonal mode switching
- Grid export management based on spot prices
- Next-day charging strategy calculation
- Various working modes (Time-of-Use, Maximize Self-Consumption, Fully Fed to Grid)

## Requirements

To use this package, you need the following integrations:

- [Huawei Solar integration by wlcrs](https://github.com/wlcrs/huawei_solar)
- [Solcast integration by oziee](https://github.com/BJReplay/ha-solcast-solar)
- [Energi Data Service integration by MTrab](https://github.com/MTrab/energidataservice)
- [Huawei Solar PEES package by JensenNick](https://github.com/JensenNick/huawei_solar_pees) (optional but recommended)

## Installation

1. Place the `huawei_solar_battery_optimization.yaml` file in your Home Assistant packages directory (usually `/config/packages/`).
2. Restart Home Assistant to load the new package.

For more information on using packages in Home Assistant, see the [official documentation](https://www.home-assistant.io/docs/configuration/packages/).

## Configuration

You may need to adjust the following input sensors in the package file to match your setup:

- `sensor.solcast_pv_forecast_forecast_today` (from Solcast integration)
- `sensor.solcast_pv_forecast_forecast_tomorrow` (from Solcast integration)
- `sensor.energi_data_service_total_price` (from Energi Data Service integration)
- `sensor.energi_data_service_spot_price` (from Energi Data Service integration)
- `sensor.batteries_state_of_capacity` (from Huawei Solar Integration)
- `sensor.inverter_active_power_control` (from Huawei Solar Integration)

## How It Works

### Daily Processes

- **6:00 AM**: Daily optimization runs, calculating energy thresholds, analyzing hourly data, and generating a summary.
- **6:05 AM**: The system implements the daily optimization, setting the working mode to Time-of-Use with disabled battery, and potentially scheduling a mode change.
- **Every 5 minutes**: The system checks if it's time to change the mode to Maximize Self-Consumption.
- **5:00 PM**: The system switches to an appropriate mode based on the current month.
- **9:00 PM**: The system calculates the charging strategy for the next day.

### Monthly Process

- On the 1st of each month, the system checks and sets the appropriate working mode based on the season.

### Continuous Processes

- The system manages inverter export based on spot prices, triggered by price changes or hourly checks.

## Available Scripts

The package includes several scripts for setting different working modes, managing grid export, and calculating charging strategies. Some of these are used in automations, while others are available for manual use or further automation improvements.

## Working Modes

This package supports several working modes to optimize your Huawei solar battery system:

### 1. Maximize Self Consumption

**Description**: This mode prioritizes using the energy generated by your solar panels to power your home and charge your battery, minimizing the amount of energy drawn from the grid.

**Use Case**: Ideal for households looking to reduce their reliance on grid electricity and maximize the use of their solar energy production.

**When to Use**: 
- During periods of high solar production
- When grid electricity prices are consistently high

### 2. Time of Use (Battery Charge / Discharge)

**Description**: This mode optimizes battery charging and discharging based on time-of-use electricity rates. It charges the battery when electricity rates are low and discharges when rates are high.

**Use Case**: Perfect for users with time-of-use electricity tariffs who want to minimize their electricity costs.

**When to Use**:
- In areas with significant differences between peak and off-peak electricity rates
- To reduce strain on the grid during peak hours
- To take advantage of lower nighttime electricity rates for charging

**Default TOU Periods** (configured in this package)
- Off-peak (charging): 00:01 - 05:59 (all days)
- Peak (discharging): 06:00 - 10:00 (all days)
- Peak (discharging): 17:00 - 23:59 (all days)

These default periods are set to optimize battery usage based on typical daily electricity demand patterns. The system charges the battery during early morning hours when demand is typically low, and discharges during morning and evening peak hours. You can adjust these periods to match your specific utility's rate schedule or your household's energy consumption patterns.

### 3. Fully Fed to Grid

**Description**: In this mode, all excess solar energy is fed back to the grid instead of being stored in the battery.

**Use Case**: Useful in scenarios where feeding energy to the grid is more beneficial than storing it.

**When to Use**:
- When grid feed-in tariffs are particularly high
- During periods of consistently high electricity spot prices
- If there's a need to reduce battery cycling to extend its lifespan

### Grid Export Management

**Description**: This feature allows you to enable or disable the export of excess energy to the grid based on current electricity spot prices.

**Use Case**: Helps optimize the financial benefits of your solar system by exporting energy when it's most profitable.

**How it Works**:
- When enabled, the system will export excess energy to the grid if the current spot price is above a set threshold.
- When disabled, excess energy will be used to charge the battery or will be curtailed if the battery is full.

**When to Use**:
- Enable during periods of high electricity spot prices to maximize revenue from energy export
- Disable when spot prices are low, and it's more beneficial to store energy in the battery for later use

By utilizing these working modes and the grid export management feature, you can tailor your Huawei solar battery system's operation to your specific needs, local energy market conditions, and personal energy goals.

## Roadmap

Future planned features include:

1. Adjustable AMP configuration for EV Charging (Wallbox Pulsar Plus) based on excessive PV production after house load.
2. Peak shaving / Capacity Control.

## Lovelace card

You can use the following lovelace card to show all entities related to HSBO using the [custom auto entities card](https://github.com/thomasloven/lovelace-auto-entities):

```yaml
- type: custom:auto-entities
  card:
    type: entities
    title: HSBO
  filter:
    include:
      - entity_id: '*hsbo*'
    exclude: []
```

## Contributing

This package is created by Heino Skov. While no official support is provided, you're free to use and edit it to your needs. Contributions, suggestions, and improvements are welcome via GitHub issues and pull requests.

## License

This project is open-source and available under the [MIT License](LICENSE).

## Disclaimer

This package is provided as-is, without any warranty or guarantee of its functionality or suitability for any particular purpose. Use at your own risk.

